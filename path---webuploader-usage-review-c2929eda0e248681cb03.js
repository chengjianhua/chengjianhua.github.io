webpackJsonp([98269796104953],{556:function(n,s){n.exports={data:{site:{siteMetadata:{title:"Blog - Jianhua Cheng",author:"Jianhua Cheng"}},markdownRemark:{id:"/Users/chengjianhua/Documents/codes/chengjianhua.github.io/src/pages/webuploader-usage-review/index.md absPath of file >>> MarkdownRemark",html:'<h1 id="微信浏览器上传图片-bug-的原因"><a href="#%E5%BE%AE%E4%BF%A1%E6%B5%8F%E8%A7%88%E5%99%A8%E4%B8%8A%E4%BC%A0%E5%9B%BE%E7%89%87-bug-%E7%9A%84%E5%8E%9F%E5%9B%A0" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>微信浏览器上传图片 bug 的原因</h1>\n<p>微信在新版本中采用的是自己的 X5 内核浏览器，而在较老的版本中还有可能是安卓的原生浏览器。具体的环境我也不太了解，但是经过实际多台安卓机型的测试，我采取的方案可以基本确保在安卓机中微信浏览器的成功上传。苹果机型没问题，因为微信的 ios 客户端使用的是 Safari 的内核，没有各种坑，且效果最好。</p>\n<!-- more -->\n<p>这里给出一个 <code class="language-text">WebUploader</code> 官方关于移动端适配的 <a href="https://github.com/fex-team/webuploader/issues/185">issues</a> 链接。里面提供的方法确实有效，但就是解决的方案并没有很清楚的展示出来，从该 issues 中有好几个人用户提出如何修改就能知道了。</p>\n<h1 id="开始时遇到的问题"><a href="#%E5%BC%80%E5%A7%8B%E6%97%B6%E9%81%87%E5%88%B0%E7%9A%84%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>开始时遇到的问题</h1>\n<h2 id="环境"><a href="#%E7%8E%AF%E5%A2%83" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>环境</h2>\n<p>后台使用 <code class="language-text">Spring MVC [V 4.08]</code>，前端使用一个开源的 <code class="language-text">HTML5</code> 框架</p>\n<h2 id="问题"><a href="#%E9%97%AE%E9%A2%98" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>问题</h2>\n<p>ios 可完美上传，安卓手机一半以上不太支持，出现进度条卡死，图片无法上传成功而且只能上传 png 格式图片的问题（后来证明是由于压缩失败引起的，在解决中详细指出）。发布到服务器上正式运营以后，发现部分用户只填写了文字信息，无法上传图片，不好统计数据，但是这样的 BUG 率显然是不行的，接下来就给出我的解决方案吧，经过实际测试应该是没问题的，不保证完全有效，因为原理不是太清楚，仅供参考。</p>\n<h1 id="后来的解决方案"><a href="#%E5%90%8E%E6%9D%A5%E7%9A%84%E8%A7%A3%E5%86%B3%E6%96%B9%E6%A1%88" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>后来的解决方案</h1>\n<h2 id="第一步，sendasbinary-true"><a href="#%E7%AC%AC%E4%B8%80%E6%AD%A5%EF%BC%8Csendasbinary-true" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第一步，sendAsBinary: true</h2>\n<p>我先是按照 issues 中给出的第一个解决方法，设置 <code class="language-text">sendAsBinary: true</code>，后台不做任何修改的情况下会产生 <code class="language-text">500</code> 的错误，但是此时解决了进度条卡死的问题（当然啊！图片直接就上传失败了！）……根据 issues 中 <strong>2betop</strong> 的回答，此时获取文件应该是直接获取文件的二进制流。</p>\n<p>之前获取图片的方式是使用 <code class="language-text">Spring</code> 自带的 <code class="language-text">MultipartHttpServletRequest</code> 将 <code class="language-text">HttpServletRequest</code> 的实例 <code class="language-text">request</code> 转换，然后获取多个文件的信息。下方代码根据实际代码删减不必要的细枝末节得出。</p>\n<div class="gatsby-highlight">\n      <pre class="language-java"><code class="language-java">        MultipartHttpServletRequest multipartRequest <span class="token operator">=</span> <span class="token punctuation">(</span>MultipartHttpServletRequest<span class="token punctuation">)</span> request<span class="token punctuation">;</span>\n\n        <span class="token comment">// 获取上传文件的列表</span>\n        Map<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> MultipartFile<span class="token operator">></span> fileMap <span class="token operator">=</span> multipartRequest<span class="token punctuation">.</span><span class="token function">getFileMap</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 图片上传前的原始名</span>\n        String originalName<span class="token punctuation">;</span>\n\n        <span class="token comment">// 循环获取多文件上传时文件列表中的每个文件对象</span>\n        <span class="token keyword">for</span> <span class="token punctuation">(</span>Map<span class="token punctuation">.</span>Entry<span class="token operator">&lt;</span>String<span class="token punctuation">,</span> MultipartFile<span class="token operator">></span> entity <span class="token operator">:</span> fileMap<span class="token punctuation">.</span><span class="token function">entrySet</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n\n            <span class="token comment">// 上传文件</span>\n            MultipartFile mf <span class="token operator">=</span> entity<span class="token punctuation">.</span><span class="token function">getValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 文件上传前的原始名</span>\n            originalName <span class="token operator">=</span> mf<span class="token punctuation">.</span><span class="token function">getOriginalFilename</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 文件扩展名</span>\n            String fileExt <span class="token operator">=</span> originalName<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>originalName<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token comment">// 文件的绝对路径File</span>\n            File uploadFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>uploadAbsolutePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n            <span class="token keyword">try</span> <span class="token punctuation">{</span>\n                FileCopyUtils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>mf<span class="token punctuation">.</span><span class="token function">getBytes</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> uploadFile<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioException<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"图片保存到文件夹中出错！"</span><span class="token punctuation">,</span> ioException<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n                logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"文件没有复制到指定的目录下"</span><span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n            <span class="token punctuation">}</span>\n\n        <span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>这是原本的获取方式，<code class="language-text">500</code> 报错时指示是第一行代码出错，无法转换，因为此时 <code class="language-text">WebUploader</code> 在设置了 <code class="language-text">sendAsBinary: true</code>后 并没有使用 <code class="language-text">content-type: multipart/form-data</code> 上传文件，而是 <code class="language-text">content-type: application/ocet-stream</code>,源码中也是这么写的，但是实际获取的请求头中并没有看到这个字段，而只是图片的类型.下列给出我使用 Chrome 的 devTools 保存下来的请求信息,只贴出 <code class="language-text">headers</code> 中的字段值（针对同一个上传 API 提出请求）：</p>\n<p><strong>500 错误时的请求头</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-json"><code class="language-json">          <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787/lostFound/front/release/upload?releaseType=0&amp;orderId=330&amp;id=WU_FILE_1&amp;name=20140120_035024000_iOS.jpg&amp;type=image%2Fjpeg&amp;lastModifiedDate=Sat+Jan+31+2015+01%3A32%3A34+GMT%2B0800+(%C3%A4%C2%B8%C2%AD%C3%A5%C2%9B%C2%BD%C3%A6%C2%A0%C2%87%C3%A5%C2%87%C2%86%C3%A6%C2%97%C2%B6%C3%A9%C2%97%C2%B4)&amp;size=81666"</span><span class="token punctuation">,</span>\n          <span class="token property">"httpVersion"</span><span class="token operator">:</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span>\n          <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Origin"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"gzip, deflate"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Host"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"localhost:8787"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept-Language"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"zh-CN,zh;q=0.8"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"User-Agent"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (iPhone; CPU iPhone OS 9_1 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13B143 Safari/601.1"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"image/jpeg"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"*/*"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Referer"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787/lostFound/"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Cookie"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"JSESSIONID=2839511C91E9ECE62D155C6EE18F3259; JSESSIONID=64B53863E1C7D82B96927F298A864E18"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Connection"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"keep-alive"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Content-Length"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"81666"</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">]</span><span class="token punctuation">,</span>\n          <span class="token property">"queryString"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"releaseType"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"0"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"orderId"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"330"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"id"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"WU_FILE_1"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"name"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"20140120_035024000_iOS.jpg"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"type"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"image%2Fjpeg"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"lastModifiedDate"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"Sat+Jan+31+2015+01%3A32%3A34+GMT%2B0800+(%C3%A4%C2%B8%C2%AD%C3%A5%C2%9B%C2%BD%C3%A6%C2%A0%C2%87%C3%A5%C2%87%C2%86%C3%A6%C2%97%C2%B6%C3%A9%C2%97%C2%B4)"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"size"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"81666"</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">]</span>，\n          <span class="token property">"bodySize"</span><span class="token operator">:</span> <span class="token number">0</span>\n</code></pre>\n      </div>\n<p><strong>在不修改 sendAsBinary: true 之前成功上传的请求头</strong></p>\n<div class="gatsby-highlight">\n      <pre class="language-json"><code class="language-json">          <span class="token property">"url"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787/lostFound/front/release/upload"</span><span class="token punctuation">,</span>\n          <span class="token property">"httpVersion"</span><span class="token operator">:</span> <span class="token string">"HTTP/1.1"</span><span class="token punctuation">,</span>\n          <span class="token property">"headers"</span><span class="token operator">:</span> <span class="token punctuation">[</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Origin"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept-Encoding"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"gzip, deflate"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Host"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"localhost:8787"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept-Language"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"zh-CN,zh;q=0.8"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"User-Agent"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"Mozilla/5.0 (iPhone; CPU iPhone OS 9_1 like Mac OS X) AppleWebKit/601.1.46 (KHTML, like Gecko) Version/9.0 Mobile/13B143 Safari/601.1"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Content-Type"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"multipart/form-data; boundary=----WebKitFormBoundaryLeVpfViKLf1xLdIr"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Accept"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"*/*"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Referer"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"http://localhost:8787/lostFound/"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Cookie"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"JSESSIONID=A76C40D04276501F54675AA02AE61467; JSESSIONID=64B53863E1C7D82B96927F298A864E18"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Connection"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"keep-alive"</span>\n            <span class="token punctuation">}</span><span class="token punctuation">,</span>\n            <span class="token punctuation">{</span>\n              <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"Content-Length"</span><span class="token punctuation">,</span>\n              <span class="token property">"value"</span><span class="token operator">:</span> <span class="token string">"44210"</span>\n            <span class="token punctuation">}</span>\n          <span class="token punctuation">]</span><span class="token punctuation">,</span>\n          <span class="token property">"queryString"</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">,</span>\n          <span class="token property">"bodySize"</span><span class="token operator">:</span> <span class="token number">929</span><span class="token punctuation">,</span>\n</code></pre>\n      </div>\n<p>比较两者的区别，发现区别：</p>\n<ul>\n<li><code class="language-text">content-type</code>： 修改为 <code class="language-text">sendAsBinary: true</code> 以后，这个值变为 <code class="language-text">image/jpeg</code>， 而之前是 <code class="language-text">multipart/form-data</code>，所以不能再使用 <code class="language-text">MultipartHttpServletRequest</code>，后端获取改为获取文件流。</li>\n<li><code class="language-text">queryString</code>：启用二进制上传以后，参数直接添加到 <code class="language-text">Url</code> 中。</li>\n<li><code class="language-text">bodySize</code>：启用之后变为 <code class="language-text">0</code>，启用之前不为 0</li>\n</ul>\n<p>先修改后端获取方式，代码更改如下：</p>\n<div class="gatsby-highlight">\n      <pre class="language-java"><code class="language-java">        File file <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>uploadAbsolutePath<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">exists</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">&amp;&amp;</span> <span class="token operator">!</span>file<span class="token punctuation">.</span><span class="token function">mkdirs</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 如果file对象不存在，那么就将该对象的路径名中不存在的文件夹目录建立出来</span>\n        <span class="token punctuation">}</span>\n\n        <span class="token comment">// 文件扩展名</span>\n        String fileExt <span class="token operator">=</span> name<span class="token punctuation">.</span><span class="token function">substring</span><span class="token punctuation">(</span>name<span class="token punctuation">.</span><span class="token function">lastIndexOf</span><span class="token punctuation">(</span><span class="token string">"."</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">1</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">toLowerCase</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token comment">// 文件的绝对路径File</span>\n        File uploadFile <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">File</span><span class="token punctuation">(</span>uploadAbsolutePath <span class="token operator">+</span> <span class="token string">"/"</span> <span class="token operator">+</span> newName<span class="token punctuation">)</span><span class="token punctuation">;</span>\n\n        <span class="token keyword">try</span> <span class="token punctuation">{</span>\n            <span class="token comment">// 将上传的图片二进制流保存为文件</span>\n            FileCopyUtils<span class="token punctuation">.</span><span class="token function">copy</span><span class="token punctuation">(</span>request<span class="token punctuation">.</span><span class="token function">getInputStream</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">FileOutputStream</span><span class="token punctuation">(</span>uploadFile<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">IOException</span> ioException<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"图片保存到文件夹中出错！"</span><span class="token punctuation">,</span> ioException<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>\n            logger<span class="token punctuation">.</span><span class="token function">error</span><span class="token punctuation">(</span><span class="token string">"文件没有复制到指定的目录下"</span> <span class="token punctuation">,</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>\n        <span class="token punctuation">}</span>\n</code></pre>\n      </div>\n<p>此时后端就能够获取前端上传的图片了，ios 机型（iPhone 6s）依然没问题，安卓上传 png 格式的图片没有任何问题，但是 jpg 依然无法上传。在后端的时候，打印 <code class="language-text">request</code> 的 <code class="language-text">headers</code>，发现安卓机型上传 jpg 图片是会丢失 <code class="language-text">content-type</code>，值为空。结合 issues 中的判断，也许是安卓机型在压缩 jpg 格式图片时出了问题，先解决再试试看！</p>\n<h2 id="第二步：加上-androidpatch"><a href="#%E7%AC%AC%E4%BA%8C%E6%AD%A5%EF%BC%9A%E5%8A%A0%E4%B8%8A-androidpatch" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>第二步：加上 androidpatch</h2>\n<p>根据官方说明，使用 <code class="language-text">webuploader.custom.js</code>，其中将 runtime/html5/androidpatch.js 打包了进来。然后在没有修改任何代码的情况下，经过五个手机的测试，新老机型：华为荣耀、魅蓝、联想等等的测试，安卓机可以在微信中随意上传图片了。这是个大坑啊！说明无法上传 jpg 格式图片的原因竟是压缩 jpg 格式图片的时候出错，导致进度条卡死，上传失败。</p>\n<h1 id="总结使用心得"><a href="#%E6%80%BB%E7%BB%93%E4%BD%BF%E7%94%A8%E5%BF%83%E5%BE%97" aria-hidden="true" class="anchor"><svg aria-hidden="true" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>总结使用心得</h1>\n<p>按照以上的总结，我想下一次我应该能再一次利用这一次的经验解决微信上传图片的坑了~也懂得从<code class="language-text">request</code> 的 <code class="language-text">headers</code> 中寻找 bug 发生的原因，<code class="language-text">WebUploader</code> 是个很优秀的开源插件，源码也写的很有条理，清晰易读，虽然我并没有读完。现在阅读框架源码是越来越轻松了，加油，下个目标是正在学习的 <code class="language-text">React.js</code>。</p>',
frontmatter:{title:"使用 WebUploader 解决安卓微信浏览器上传图片中遇到的 bug",date:"April 09, 2016"}}},pathContext:{slug:"/webuploader-usage-review/",previous:{fields:{slug:"/web-full-stack-review/"},frontmatter:{title:"WEB 全栈的学习"}},next:{fields:{slug:"/websocket-theory/"},frontmatter:{title:"WebSocket 原理"}}}}}});
//# sourceMappingURL=path---webuploader-usage-review-c2929eda0e248681cb03.js.map